{%extends 'layout.html' %}
{% block title %} Cluster management {% endblock %}
{% block content %}
{% include 'clustermain-us-templates.html' %}
<script type="text/javascript">
AWS.config.credentials = new AWS.WebIdentityCredentials({
        RoleArn: "arn:aws:iam::315557446885:role/tcdiracwebRoleGoogle",
    }); 
AWS.config.region = 'us-east-1';
AWS.config.credentials.params.WebIdentityToken = "{{session['id_token']}}";
AWS.config.sslEnabled = true;
//globals
g_instance_id = '{{ instance_id }}';
g_scgenerate_url = '{{ url_for('scgenerate_config') }}';
</script>
<script type="text/javascript" src="{{
    url_for('static', filename='js/clustermain.js')
}}"></script>

<style>
    form#cluster_config {
        padding: 10px;
    }
    form span.default-value {
        font-style: italic;
    }
    tr.log_row {
        hidden: true;
    }

    textarea.logs {
        width:100%;
    }
    tr.clusterRow {
        width:100%;
    }
    td.cluster_name {
        font-style:bold;
    }
</style>
<script type="text/template" id="template-cluster">
    <td id="cluster_name" class="cluster_name">
        <%= cluster_name %>
    </td>
    <td id="region" class="region">
        <%= region %>
    </td>
    <td id="num_nodes" class="num_nodes">
        <span class="badge"><%= num_nodes %></span>
    </td>
    <td id="cluster_management" class="cluster_management">
        <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" 
            data-toggle="dropdown">
  Cluster Management <span class="caret"></span></button>
        <ul class="dropdown-menu" id="cluster-management" role="menu">
            <li class="launch"><a href="#">Launch</a></li>
            <li class="restart"><a href="#">Restart</a></li>
            <li class="terminate"><a href="#">Terminate</a></li>
        </ul>
        </div>
    </td>
    <td id="cluster_management" class="server_management">
        <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" 
            data-toggle="dropdown">
        Server Management <span class="caret"></span></button>
        <ul class="dropdown-menu" id="server-management" role="menu">
            <li class="start-logger"><a href="#">Start Logger</a></li>
                <li class="start-gpu0"><a href="#">Start GPU0</a></li>
                <li class="start-gpu1"><a href="#">Start GPU1</a></li>
        </ul>
    </div>
    </td>
</script>
<div class="row">
    <div class="col-md-12 page-header">
        <h1>Cluster management console</h1>
    </div>
</div>
<div class="row">
<div class="col-md-4" id="cluster-form-container">
        
</div>
<script type="text/javascript">
    ClusterFormView = Backbone.View.extend({
        initialize : function(){
            this.render();
        },
        render : function(){
            var template = _.template($('#cluster-form').html(), {});
            this.$el.html( template )
        }
    });
    var cluster_form = new ClusterFormView({ el: $('div#cluster-form-container') });

</script>
<div class="panel panel-default col-md-8">
     <div class="panel-heading">Clusters</div>
     <table id="cluster-table" class="tablesorter table-hover" width=100%>
         <thead>
             <tr>
                 <th>Name</th>
                 <th>Type</th>
                 <th>Region</th> 
                <th>Start Cluster</th>
                <th>Scratch</th>
                <th>Info</th>
             </tr>
        </thead>
        <tbody id="cluster-body">
        </tbody>
     </table>
</div>
</div> 
<!-- row -->
<div class="panel panel-default col-md-8">
<table id="container-clustersview">
</table>
</div>

<script type="text/javascript">
    var ClusterModel = Backbone.Model.extend({
launch : function(){
    console.log(this.get('cluster_name') + ' launch');
},
terminate :function(){
    console.log(this.get('cluster_name') + ' terminate');
},
restart : function(){
    console.log( this.get('cluster_name') + ' restart');
}

            });

    var ClustersModel = Backbone.Collection.extend({
        model: ClusterModel
     });

    var ClustersView = Backbone.View.extend({
            type: "ClustersView",
            el: "#container-clustersview",
            initialize: function (){
            },
            render : function(){
                _.each(this.collection.models, this.processCluster, this);
                return this;
            },
            processCluster : function(cluster ){
                var clusterView = new ClusterView({ model: cluster });
                clusterView.render();
                this.$el.append(clusterView.el);
            }
    });

    var ClusterView = Backbone.View.extend({
type : "ClusterView",
template: _.template($('#template-cluster').html()),
tagName: "tr",
className: "clusterRow",

initialize : function(){
    this.model.on("change", this.clusterChanged, this);
},

clusterChanged: function( model, changes ){
    console.log("clusterChanged:" + model.get("cluster_name"));
},

events : {
'click .launch': 'launchCluster',
'click .restart': 'restartCluster',
'click .terminate': 'terminateCluster',
},

launchCluster: function(){
this.model.launch();
               },
render: function () {
  var outputHtml = this.template(this.model.toJSON());
  this.$el.html(outputHtml);
  return this;
},                                                                         
restartCluster: function(){
    this.model.restart();
                },
terminateCluster: function(){
    this.model.terminate();
}                
});

/**
c = get_clusters();
if(! c.length){
    c = scan_results;
}

clustersa = new ClustersModel(c );
ClusterViewTable = new ClustersView({ collection: clustersa });
ClusterViewTable.render();
**/

</script>
{% endblock %}
